<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ECharts Geo3D 点击事件调试</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #0f172a;
        font-family: Arial, sans-serif;
        color: white;
      }
      #map-container {
        width: 800px;
        height: 600px;
        margin: 20px auto;
        border: 2px solid #3b82f6;
      }
      #debug-info {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 300px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid #3b82f6;
        padding: 15px;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
      }
      .debug-item {
        margin-bottom: 10px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        font-size: 12px;
      }
      .event-type {
        color: #60a5fa;
        font-weight: bold;
      }
      .event-data {
        color: #cbd5e1;
        margin-top: 5px;
      }
      .clear-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>ECharts Geo3D 点击事件调试</h1>
    <div id="map-container"></div>

    <div id="debug-info">
      <button class="clear-btn" onclick="clearDebugInfo()">清除日志</button>
      <div id="debug-log"></div>
    </div>

    <script>
      let myChart;
      let debugLog = [];

      // 调试输出函数
      function addDebugLog(type, data) {
        const timestamp = new Date().toLocaleTimeString();
        debugLog.unshift({
          type: type,
          data: data,
          timestamp: timestamp,
        });

        // 限制日志数量
        if (debugLog.length > 50) {
          debugLog = debugLog.slice(0, 50);
        }

        updateDebugDisplay();
      }

      function updateDebugDisplay() {
        const logContainer = document.getElementById("debug-log");
        logContainer.innerHTML = debugLog
          .map(
            (log) => `
                <div class="debug-item">
                    <div class="event-type">[${log.timestamp}] ${log.type}</div>
                    <div class="event-data">${JSON.stringify(
                      log.data,
                      null,
                      2
                    )}</div>
                </div>
            `
          )
          .join("");
      }

      function clearDebugInfo() {
        debugLog = [];
        updateDebugDisplay();
      }

      // 初始化地图
      function initMap() {
        addDebugLog("INIT", "开始初始化地图");

        const chartDom = document.getElementById("map-container");
        myChart = echarts.init(chartDom);

        // 简单的测试数据
        const testGeoJSON = {
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              properties: { name: "测试区域A" },
              geometry: {
                type: "Polygon",
                coordinates: [
                  [
                    [119.5, 29.0],
                    [120.0, 29.0],
                    [120.0, 29.5],
                    [119.5, 29.5],
                    [119.5, 29.0],
                  ],
                ],
              },
            },
            {
              type: "Feature",
              properties: { name: "测试区域B" },
              geometry: {
                type: "Polygon",
                coordinates: [
                  [
                    [120.0, 29.0],
                    [120.5, 29.0],
                    [120.5, 29.5],
                    [120.0, 29.5],
                    [120.0, 29.0],
                  ],
                ],
              },
            },
          ],
        };

        echarts.registerMap("test", testGeoJSON);
        addDebugLog("MAP_REGISTERED", "测试地图已注册");

        const option = {
          backgroundColor: "#0f172a",
          geo3D: {
            map: "test",
            boxHeight: 10,
            regionHeight: 2,
            shading: "lambert",
            viewControl: {
              distance: 80,
              alpha: 45,
              beta: 40,
            },
            itemStyle: {
              color: "#3b82f6",
              opacity: 0.8,
              borderWidth: 2,
              borderColor: "#60a5fa",
            },
            emphasis: {
              itemStyle: {
                color: "#ef4444",
              },
            },
            label: {
              show: true,
              textStyle: {
                color: "#ffffff",
                fontSize: 14,
              },
            },
          },
        };

        myChart.setOption(option);
        addDebugLog("OPTION_SET", "地图配置已设置");

        // 设置所有可能的事件监听器
        setupEventListeners();
      }

      function setupEventListeners() {
        addDebugLog("EVENTS", "开始设置事件监听器");

        // 1. 通用点击事件
        myChart.on("click", function (params) {
          addDebugLog("CLICK_GENERIC", {
            componentType: params.componentType,
            name: params.name,
            dataIndex: params.dataIndex,
            seriesIndex: params.seriesIndex,
          });
        });

        // 2. geo3D专用点击事件
        myChart.on("geo3d:click", function (params) {
          addDebugLog("CLICK_GEO3D", {
            name: params.name,
            componentType: params.componentType,
            event: params.event ? "present" : "missing",
          });
        });

        // 3. 鼠标移动事件
        myChart.on("mousemove", function (params) {
          if (params.componentType === "geo3D") {
            addDebugLog("MOUSEMOVE_GEO3D", {
              name: params.name,
            });
          }
        });

        // 4. 鼠标悬停事件
        myChart.on("mouseover", function (params) {
          if (params.componentType === "geo3D") {
            addDebugLog("MOUSEOVER_GEO3D", {
              name: params.name,
            });
          }
        });

        // 5. 鼠标离开事件
        myChart.on("mouseout", function (params) {
          if (params.componentType === "geo3D") {
            addDebugLog("MOUSEOUT_GEO3D", {
              name: params.name,
            });
          }
        });

        // 6. ZRender层级事件
        if (myChart.getZr) {
          const zr = myChart.getZr();
          if (zr) {
            zr.on("click", function (params) {
              addDebugLog("ZRENDER_CLICK", {
                target: params.target ? params.target.type : "no target",
                topTarget: params.topTarget
                  ? params.topTarget.type
                  : "no topTarget",
              });
            });

            zr.on("mousedown", function (params) {
              addDebugLog("ZRENDER_MOUSEDOWN", {
                target: params.target ? params.target.type : "no target",
              });
            });

            zr.on("mouseup", function (params) {
              addDebugLog("ZRENDER_MOUSEUP", {
                target: params.target ? params.target.type : "no target",
              });
            });
          }
        }

        // 7. DOM级别事件
        const mapContainer = document.getElementById("map-container");
        mapContainer.addEventListener("click", function (e) {
          addDebugLog("DOM_CLICK", {
            clientX: e.clientX,
            clientY: e.clientY,
            offsetX: e.offsetX,
            offsetY: e.offsetY,
            target: e.target.tagName,
          });
        });

        addDebugLog("EVENTS_COMPLETE", "所有事件监听器设置完成");
      }

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", function () {
        initMap();
      });
    </script>
  </body>
</html>

