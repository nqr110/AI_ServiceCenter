<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>点击事件调试</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #test-container {
        width: 800px;
        height: 600px;
        border: 1px solid #ccc;
        margin-bottom: 20px;
      }
      #debug-info {
        background: #f5f5f5;
        padding: 10px;
        border: 1px solid #ddd;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        margin: 5px;
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #2563eb;
      }
    </style>
  </head>
  <body>
    <h1>点击事件调试页面</h1>
    <div id="test-container"></div>
    <button onclick="clearDebug()">清除调试信息</button>
    <button onclick="testClick()">模拟点击事件</button>
    <div id="debug-info">等待操作...</div>

    <script>
      let myChart;

      // 调试输出函数
      function debugOutput(msg) {
        const el = document.getElementById("debug-info");
        if (el) {
          const timestamp = new Date().toLocaleTimeString();
          el.textContent = `[${timestamp}] ${msg}\n${el.textContent}`;
        }
        console.log(msg);
      }

      function clearDebug() {
        document.getElementById("debug-info").textContent = "调试信息已清除...";
      }

      function testClick() {
        debugOutput("测试按钮被点击 - 手动触发");
      }

      // 初始化地图
      function initMap() {
        debugOutput("开始初始化地图...");

        const chartDom = document.getElementById("test-container");
        myChart = echarts.init(chartDom, null, {
          renderer: "canvas",
          useDirtyRect: false,
        });

        debugOutput("ECharts实例已创建");

        // 加载数据
        Promise.all([
          fetch("/api/jinhua-geojson").then((response) => response.json()),
          fetch("/api/district-data").then((response) => response.json()),
        ])
          .then(([geoJson, districtData]) => {
            debugOutput("数据加载成功");

            // 注册地图
            echarts.registerMap("jinhua", geoJson);

            // 配置地图
            const option = {
              backgroundColor: "#0f172a",
              geo3D: {
                map: "jinhua",
                boxHeight: 20,
                regionHeight: 3,
                shading: "lambert",
                environment: "none",
                light: {
                  main: {
                    color: "#ffffff",
                    intensity: 0.8,
                    shadow: false,
                    alpha: 45,
                    beta: 30,
                  },
                  ambient: {
                    intensity: 0.7,
                  },
                },
                viewControl: {
                  projection: "perspective",
                  alpha: 45,
                  beta: 40,
                  distance: 130,
                  panSensitivity: 0.5,
                  rotateSensitivity: 0.5,
                  zoomSensitivity: 0.2,
                  autoRotate: false,
                  damping: 0.98,
                  enableZoom: true,
                  enableRotate: true,
                  enablePan: true,
                },
                itemStyle: {
                  color: "rgba(59, 130, 246, 1.0)",
                  opacity: 1.0,
                  borderWidth: 1,
                  borderColor: "rgba(147, 197, 253, 1.0)",
                  sideColor: "rgba(30, 64, 175, 1.0)",
                },
                label: {
                  show: true,
                  formatter: function (params) {
                    return params.name;
                  },
                  rich: {
                    a: {
                      color: "#ffffff",
                      fontSize: 16,
                      fontWeight: "bold",
                      backgroundColor: "rgba(59, 130, 246, 0.9)",
                      padding: [6, 12],
                      borderRadius: 20,
                      borderColor: "rgba(147, 197, 253, 0.8)",
                      borderWidth: 1,
                    },
                  },
                },
              },
            };

            myChart.setOption(option, true);
            debugOutput("地图配置已设置");

            // 设置事件监听器
            setupEventListeners();
          })
          .catch((error) => {
            debugOutput("数据加载失败: " + error.message);
            console.error("数据加载失败:", error);
          });
      }

      // 设置事件监听器
      function setupEventListeners() {
        debugOutput("设置事件监听器...");

        // 1. ECharts点击事件
        myChart.on("click", function (params) {
          debugOutput(
            "ECharts点击事件触发! 组件类型: " +
              params.componentType +
              ", 名称: " +
              params.name
          );
          console.log("ECharts点击事件详情:", params);

          // 检查是否是地图点击
          if (
            params.componentType === "geo3D" ||
            params.componentType === "geo"
          ) {
            debugOutput("地图区域被点击: " + params.name);
            handleDistrictClick(params);
          } else {
            debugOutput("非地图区域被点击");
          }
        });

        // 2. 鼠标悬停事件
        myChart.on("mouseover", function (params) {
          if (
            params.componentType === "geo3D" ||
            params.componentType === "geo"
          ) {
            debugOutput("鼠标悬停在: " + params.name);
          }
        });

        // 3. 鼠标移出事件
        myChart.on("mouseout", function (params) {
          if (
            params.componentType === "geo3D" ||
            params.componentType === "geo"
          ) {
            debugOutput("鼠标移出: " + params.name);
          }
        });

        debugOutput("事件监听器设置完成");
      }

      // 处理地块点击事件
      function handleDistrictClick(params) {
        debugOutput("处理地块点击: " + params.name);
        console.log("地块点击详情:", params);
      }

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", function () {
        debugOutput("页面加载完成，开始初始化...");
        initMap();
      });
    </script>
  </body>
</html>
